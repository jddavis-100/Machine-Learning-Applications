#Children z-score analyses in developing country
#load library and make summary plots

library(ggplot2)
setwd("~/PathToYourData")

#load the data and assign a vector

data.gc <- read.csv("~/PathToYourData", header=TRUE)
mydata <- read.table("~/PathToYourData", header = TRUE,
                     sep=",")

#remove missing values and subset data by gender

clean_mydata <- na.omit(mydata)
head(clean_mydata) #check the dataframe looks ok
tail(clean_mydata) #check the dataframe looks ok
boys <- subset(clean_mydata, Gender__c=="1")
girls <- subset(clean_mydata, Gender__c=="2")
boys_all <- subset(mydata, Gender__c=="1")
girls_all <- subset(mydata, Gender__c=="2")

girls_low_zhfa <- subset(girls_all, zhfa< (1*-5))
girls_low_zhfa # about 53 girls have severely low z-score for height

boys_low_zhfa <- subset(boys_all, zhfa< (1*-5))
boys_low_zhfa # 4 boys have severely low z-score for height

girls_low_zwfa <- subset(girls_all, zwfa< (1*-5))
girls_low_zwfa # none of the girls in this data set have severely low z-scores for weight

boys_low_zwfa <- subset(boys_all, zwfa< (1*-5))
boys_low_zwfa # none of the boys in this data set have severely low z-scores for weight

girls_low_zbfa <- subset(girls_all, zbfa<(1*-5))
girls_low_zbfa # two girls in this set have severely low z-scores for bmi

boys_low_zbfa <- subset(boys_all, zbfa<(1*-5))
boys_low_zbfa # about 28 boys have severely low z-scores for bmi scores for their age

#make csv outputs for all the children with flagged z-scores

write.csv(girls_low_zwfa, file="girls_severe_zwfa.csv")
write.csv(boys_low_zwfa, file="boys_severe_zwfa.csv")

write.csv(girls_low_zhfa, file="girls_severe_zhfa.csv")
write.csv(boys_low_zhfa, file="boys_severe_zhfa.csv")

write.csv(girls_low_zbfa, file="girls_severe_zbfa.csv")
write.csv(boys_low_zbfa, file="boys_severe_zbfa.csv")

#plots to look at summary of z score difference
#zbfa, BMI-for-age z-score
#zhfa, Height-for-age z-score
#zwfa, Weight-for-age z-score
#gender = 1 for males
#gender = 2 for females
#cbmi = calculated BMI
#Weight_kg__c = weight of the child
#age.mo = age of child in months

#now run the qplot on samples, include all samples or subset...it will only plot values that exist
#average positive z-scores present an observation above the mean, i.e. child is taller than average for age
#average negative z-scores present an observation below the mean, i.e. child is shorter than average for age

qplot(age.mo, Weight_kg__c, colour=age.mo,data=mydata)
qplot(age.mo, Gender__c, colour=age.mo, data=mydata)
qplot(age.mo, Height_cm__c, colour=age.mo, data=mydata)
qplot(Gender__c, Weight_kg__c, colour=Gender__c, data=mydata)
qplot(Gender__c, zhfa, colour=zhfa, data=mydata)
qplot(Gender__c, zbfa, colour=zbfa, data=mydata)
qplot(Gender__c, zwfa, colour=zwfa, data=mydata)
qplot(zbfa, age.mo, colour = zbfa, data=mydata)
qplot(zwfa, age.mo, colour = zwfa, data=mydata)
qplot(zhfa, age.mo, colour = zhfa, data=mydata)
qplot(age.mo, cbmi, colour=cbmi, data=mydata)
qplot(age.mo, zhfa, colour=age.mo, data=girls)
qplot(age.mo, zhfa, colour=age.mo, data=boys)
qplot(age.mo, zbfa, colour=age.mo, data=girls)
qplot(age.mo, zwfa, colour=age.mo, data=girls)
qplot(age.mo, zhfa, colour=age.mo, data=boys)
qplot(age.mo, zbfa, colour=age.mo, data=boys)
qplot(age.mo, zwfa, colour=age.mo, data=boys)


#visually assess for normality.  A normal distribution will have even tailing ends on both sides.

#data <- mydata[sample(nrow(mydata), 1000),]
#qplot(zhfa, data=data, geom="histogram") #suggests skew, should sepparate by gender
#qplot(zwfa, data=data, geom="histogram") #no skew
#qplot(zbfa, data=data, geom="histogram") #suggests skew, should sepparate by gender

qplot(zhfa, data=girls, geom="histogram")
qplot(zhfa, data=boys, geom="histogram")


#load libraries for univariate analysis and machine learning
#use subsetted data

library(fBasics)
library(caret)
library(pastecs)
#statistics, univariate on cleaned and subsetted data
options(scipen=100)
options(digits=10)
summary_girls <- summary(girls)
summary_girls
write.csv(summary_girls, file="summary_stats_girls.csv")
summary_boys <- summary(boys)
summary_boys
write.csv(summary_boys, file="summary_stats_boys.csv")
summary_all <- summary(mydata)
summary_all
write.csv(summary_all, file="summary_stats_all_data.csv")

summary(clean_mydata$zhfa)
summary(clean_mydata$zbfa)
summary(clean_mydata$zwfa)
summary(girls$zhfa)
summary(boys$zhfa)

#show the means
mean_zhfa_girls <- mean(girls$zhfa)
mean_zhfa_girls
mean_zhfa_boys <- mean(boys$zhfa)
mean_zhfa_boys
median(girls$zhfa)
median(boys$zhfa)

#Since there is some skew by visual assessment and summary stats (compare mean to median)
#we will determine how much skew and whether a transformation is necessary. In this instance we will probably do a 
#log transformation or choose a non-parametric test depending upon outcomes of skewness and kurtosis.
#Skewness is a measure of symmetry and tells us which tests we can reasonably apply to the data

#In its current state we need to decide whether or not we need to do a transformation

#Kurtosis will tells use whether the data are peaked or flat realative to a normal distribution
#if the distribution is not normal, then a transformation to normalize is necessary or choosing another appropriate option, 
#e.g. non-parametric test 

#A different set of tests could be used to test for true differences as well.

skewness(clean_mydata$zhfa)
skewness(clean_mydata$zbfa)
skewness(clean_mydata$zwfa)
skewness(girls$zhfa)
skewness(boys$zhfa)

#symmetric data should have a skewness near zero
#Kurtosis for a standard normal distribution is 3, but we are calculating excess kurtosis
#thus the SND is set to zero and kurtosis is relative to that zero
#we see there is some skew so we look at the kurtosis to determine what type of skew
#and severity
#to a t-test between groups

library(e1071)
kurtosis(girls$zwfa)
kurtosis(girls$zhfa)
kurtosis(girls$zbfa)
kurtosis(boys$zwfa)
kurtosis(boys$zhfa)
kurtosis(boys$zbfa)

#here we see that the outcome is "excess" kurtosis, for all the z-scores, so we will need to normalize the data
#however when we look at the numbers the only skew over 1 is boys zhfa, zbfa, girls zhfa is also over 0.5 kurtosis
#determine the degree of normality problems using Shapiro-Wilk normality test
#this test tells us if we really do have to worry about the skew and do a data transformation or
#non-parametric test
#here I will choose a non-parametric t-test since data transformation is not going to be easy on
#a dataset with lots of missing values and skew.  Interpret: if p<0.01 then its significantly altered from the 
#normal distribution

shapiro.test(girls$zhfa)
shapiro.test(girls$zwfa)
shapiro.test(girls$zbfa)
shapiro.test(boys$zhfa)
shapiro.test(boys$zwfa)
shapiro.test(boys$zbfa)

#now we will analyze the flagged scores (boys and girls that are outside WHO limits)

shapiro.test(girls$fhfa)
shapiro.test(girls$fwfa)
shapiro.test(girls$fbfa)
girls$fhfa
girls$fwfa
girls$fbfa
boys$fhfa

#non-parametric test
#here we use a substitute for t-test called the independent 2-group Mann-Whitney U Test which corrects
#for lack of continuity
#determine if there is a true difference in zbfa btwn boys an girls


x <- boys$zbfa
y <- girls$zbfa
wilcox.test(x,y)

a <- boys$zhfa
b <- girls$zhfa
wilcox.test(a,b)

c <- boys$zwfa
d <- girls$zwfa
wilcox.test(c,d)

e <- boys$cbmi
f <- girls$cbmi
wilcox.test(e,f)

g <- boys$Weight
h <- girls$Weight
wilcox.test(g,h)

#final descriptive stats

stat.desc(clean_mydata)
stat.desc(girls)
stat.desc(boys)
dim(girls)
dim(boys)

#We will now print out the girls and boys flagged for z-scores severely below 
#normgirls_flagged_fhfa <- subset(girls_all, fhfa==1)
#An analysis of the data however shows that the flagging didn't work correctly, i.e. not all the scores that should be flagged
#are flagged
#To correct this we made a sub-set of all the children with severely low z-scores and output it to csv files

girls_flagged_fwfa <- subset(girls_all, fwfa==1)
girls_flagged_fwfa

girls_flagged_fbfa <- subset(girls_all, fbfa==1)
girls_flagged_fbfa

boys_flagged_fhfa <- subset(boys_all, fhfa==1)
boys_flagged_fhfa

boys_flagged_fwfa <- subset(boys_all, fwfa==1)
boys_flagged_fwfa

boys_flagged_fbfa <- subset(boys_all, fbfa==1)
boys_flagged_fbfa
